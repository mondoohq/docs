### Set up keyless authentication with GCP

#### Prerequisites

- Sufficient GCP privileges to create and manage service accounts

- Editor or Owner privileges in the Mondoo space to which your workload needs access

#### Step A: Prepare your GCP environment for WIF

1. Create a GCP Service Account. To learn how, read [Create service accounts](https://cloud.google.com/iam/docs/service-accounts-create).

2. Go the **Service account details** page and note the service accountâ€™s unique ID. You need this value when you configure the workload identity provider.

3. Assign the managed identity to a virtual machine or another resource where your workload runs. To learn how, read [Create a VM and attach the service account](https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances#using).

#### Step B: Retrieve credentials from GCP

Open Google Cloud Shell and run this command:

```bash
curl -H "Metadata-Flavor: Google" "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/identity?audience=foo"
```

GCP returns the token that you need to create a trust relationship between Mondoo and GCP.

#### Step C: Create an identity provider in Mondoo

1. In the Mondoo Console, [navigate](/platform/start/navigate/) to the space in which you want to set up keyless access for non-human users.

2. In the left navigation, select **Settings**. Then select the **Identity Providers** tab.

   Screenshot to come. deets

3. Select the **ADD IDENTITY PROVIDER** button or the plus (+) symbol near the top-right corner of the tab.

   Screenshot to come. deets

4. Select **Google**.

   Screenshot to come. deets

5. In the **Issuer URL** box, keep the default `https://accounts.google.com`.

6. In the **Subject** box, enter the unique ID of the GCP server account you created in the previous instructions.

7. In the **Expiration time** list, choose the duration of sessions authenticated with this WIF provider.

8. In the **Name** and **Description** boxes, provide a short name and longer description that help you and your teammates recognize the source and purpose of the identity provider.

9. Select the **ADD IDENTITY PROVIDER** button.

   Screenshot to come. deets

   Mondoo generates and displays the configuration values that you need to create a trust relationship between Mondoo and GCP.

#### Step D: Create a trust between Mondoo and GCP

Make a curl call to exchange a local token for a short-lived Mondoo service account:

```bash
curl --request POST \
  --url 'UNIVERSE_DOMAIN/SecureTokenService/ExchangeExternalToken?=' \
  --header 'content-type: application/json' \
  --data '{
  "audience": "AUDIENCE",
  "issuer_uri": "ISSUER",
  "jwt_token": "TOKEN"
  }'
```

| For...   | Substitute...                                                                               |
|:-------- |:------------------------------------------------------------------------------------------- |
| AUDIENCE | The `audience` value Mondoo provided when you followed the instructions in **Step C** above |
| ISSUER   | The `issuer` value Mondoo provided when you followed the instructions in **Step C** above   |
| TOKEN    | The token GCP provided when you followed the the instructions in **Step B** above           |

This call returns a Mondoo service account in the form of a `base64_credential` value, which your workload can use to access the Mondoo space.

Screenshot to come. deets
